name: Auto Create Issue from Push

on:
  push:
    branches:
      - main  # 监听的分支

permissions:
  contents: read
  issues: write  # 需要创建 Issue 的权限

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # 获取最近两次提交以对比差异

      - name: Generate Issue Body
        id: get_diff
        run: |
          # 获取最近一次提交的 Commit Message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          # 获取修改的文件列表
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          
          # 构造 Issue 内容
          echo "TITLE=Auto-Sync: $COMMIT_MSG" >> $GITHUB_ENV
          
          # 这里使用多行字符串写入环境变量
          {
            echo 'BODY<<EOF'
            echo "## 自动化提交报告"
            echo "此 Issue 由 GitHub Actions 自动生成。"
            echo ""
            echo "### 提交信息"
            echo "$COMMIT_MSG"
            echo ""
            echo "### 变动文件"
            echo "$CHANGED_FILES"
            echo ""
            echo "### 相关 Commit"
            echo "${{ github.sha }}"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Create Issue
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: ${{ env.TITLE }}
          body: ${{ env.BODY }}
          labels: auto-sync
